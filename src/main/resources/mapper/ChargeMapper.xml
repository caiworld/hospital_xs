<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.caihao.hospitalmanager.mapper.ChargeMapper" >
  <resultMap id="BaseResultMap" type="com.caihao.hospitalmanager.entity.Charge" >
    <!--
      WARNING - @mbg.generated
    -->
    <id column="id" property="id" jdbcType="INTEGER" />
    <result column="patient_id" property="patientId" jdbcType="INTEGER" />
    <result column="name" property="name" jdbcType="VARCHAR" />
    <result column="price" property="price" jdbcType="DECIMAL" />
    <result column="num" property="num" jdbcType="INTEGER" />
    <result column="total" property="total" jdbcType="DECIMAL" />
    <result column="begin_time" property="beginTime" jdbcType="TIMESTAMP" />
    <result column="end_time" property="endTime" jdbcType="TIMESTAMP" />
  </resultMap>

  <!--通过病人名称或身份证号查询病人收费信息-->
  <select id="selectChargeDtoList" resultType="com.caihao.hospitalmanager.entity.dto.ChargeDto">
    SELECT * FROM (
      SELECT
        c.id,
        c.patient_id,
        p.`name` AS "patientName",
        p.number,
        c.`name`,
        c.price,
        c.num,
        c.total,
        c.begin_time,
        c.end_time
      FROM charge AS c
      LEFT JOIN patient AS p ON c.patient_id = p.id
      WHERE 1=1 AND c.is_del = 0
      <if test="name != null">
        AND INSTR(p.`name`, #{name})
      </if>
      <if test="number != null">
        AND INSTR(p.number, #{number})
      </if>
      ORDER BY c.id DESC
    ) AS ch
    GROUP BY ch.patient_id
    ORDER BY ch.id DESC
  </select>

  <select id="getChargeListByPatientId" resultType="com.caihao.hospitalmanager.entity.Charge">
    SELECT
      patient_id,
      `name`,
      price,
      num,
      total,
      begin_time,
      end_time
    FROM charge
    WHERE patient_id = #{patientId}
    AND is_del = 0
  </select>

  <!--根据病人id删除收费信息-->
  <update id="deleteByPatientId" parameterType="int">
    UPDATE charge
    SET is_del = 1
    WHERE patient_id = #{patientId}
    AND is_del = 0
  </update>

  <!--批量插入收费信息-->
  <insert id="insertChargeList">
    INSERT INTO charge(patient_id,`name`,price,num,total,begin_time,end_time)
    VALUES
    <foreach collection="chargeList" item="charge" separator=",">
      (#{patientId},#{charge.name},#{charge.price},#{charge.num},#{charge.total},
      #{charge.beginTime},#{charge.endTime})
    </foreach>
  </insert>

  <!--查询收费信息综合-->
  <select id="selectChargeSumDto" resultType="com.caihao.hospitalmanager.entity.dto.ChargeSumDto">
    SELECT
      c.patient_id,
      p.`name` AS "patientName",
      p.number,
      SUM(c.total) AS "sum",
      MIN(c.begin_time) AS "beginTime",
      MAX(c.end_time) AS "endTime"
    FROM charge AS c
    LEFT JOIN patient AS p ON c.patient_id = p.id
    WHERE 1=1 AND c.is_del = 0
    <if test="name != null">
      AND INSTR(p.`name`, #{name})
    </if>
    <if test="number != null">
      AND INSTR(p.number, #{number})
    </if>
    GROUP BY c.patient_id
    ORDER BY c.id DESC
  </select>
</mapper>